<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TASK Resume Builder</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- DOCX export -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>

  <style>
    :root { --ink:#111827; --muted:#6b7280; --line:#e5e7eb; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; color:var(--ink); }

    /* Sections */
    .form-section { display:none; animation:fadeIn .28s ease-out; }
    .form-section.active { display:block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

    /* Preview (classic) */
    #resumePreview { font-family: 'Times New Roman', Times, serif; color:#1f2937; }
    #resumePreview h3 { font-size:24px; font-weight:700; text-align:center; margin-bottom:4px; }
    #resumePreview .contact-info { font-size:12px; text-align:center; color:#4b5563; margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid #374151; }
    #resumePreview h4 { font-size:16px; font-weight:700; text-transform:uppercase; margin-top:16px; margin-bottom:8px; border-bottom:1px solid #6b7280; padding-bottom:4px; }
    #resumePreview .entry { margin-bottom:12px; }
    #resumePreview .entry-header { display:flex; justify-content:space-between; align-items:baseline; }
    #resumePreview .title { font-weight:700; font-size:14px; }
    #resumePreview .meta { font-style:italic; font-size:13px; color:#6b7280; }
    #resumePreview ul { list-style-position:outside; padding-left:20px; margin-top:4px; }
    #resumePreview li { font-size:13px; margin-bottom:4px; line-height:1.55; color:#374151; }

    /* Modal: hidden by default; shown via JS only on email/download attempts */
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:50; }

    /* Inputs are styled once via JS to avoid repetition in templates */
  </style>
</head>
<body class="bg-gray-100">

  <div class="min-h-screen bg-gradient-to-br from-purple-600 to-indigo-700 p-4 sm:p-6 lg:p-8 flex items-center justify-center">
    <div class="container w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">

      <!-- Header -->
      <header class="bg-gradient-to-br from-purple-600 to-indigo-700 text-white p-6 sm:p-8 text-center">
        <h1 class="text-3xl sm:text-4xl font-bold flex items-center justify-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M15.5 2H8.6c-.4 0-.8.2-1.1.5-.3.3-.5.7-.5 1.1V21c0 .8.7 1.5 1.5 1.5h8c.8 0 1.5-.7 1.5-1.5V6.5L15.5 2z"/><path d="M15 2v5h5"/><path d="M10 16s-1 1-2 1-2-1-2-1"/><path d="M10 12s-1 1-2 1-2-1-2-1"/><path d="m14 12 4 4"/><path d="m18 12-4 4"/></svg>
          TASK Resume Builder
        </h1>
        <p class="mt-2 text-indigo-200 text-lg">Build your professional resume step-by-step</p>
        <!-- Progress -->
        <div class="mt-6 bg-white/20 h-2.5 rounded-full overflow-hidden">
          <div id="progressBar" class="bg-white h-full rounded-full transition-all duration-500 ease-out" style="width:0%"></div>
        </div>
      </header>

      <main class="p-6 sm:p-8">
        <form id="resumeForm"></form>
      </main>
    </div>
  </div>

  <!-- Incomplete Modal -->
  <div id="warningModal" class="modal-overlay">
    <div class="w-full h-full flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-md text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
          <svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.07 19h15.86c1.54 0 2.5-1.67 1.73-3L13.73 4c-.77-1.33-2.69-1.33-3.46 0L2.34 16c-.77 1.33.19 3 1.73 3z"/></svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mt-4">Resume may be incomplete</h3>
        <p class="text-sm text-gray-600 mt-2">We didn’t find enough info to build a solid resume. Do you still want to continue?</p>
        <div class="mt-5 flex flex-col sm:flex-row gap-3 justify-center">
          <button type="button" id="modalContinueBtn" class="px-6 py-3 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 font-semibold">Continue anyway</button>
          <button type="button" id="modalCancelBtn" class="px-6 py-3 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold">Go back & edit</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ========= State ========= */
    let currentSection = 0; // splash
    const form = document.getElementById('resumeForm');
    const progressBar = document.getElementById('progressBar');
    const modal = document.getElementById('warningModal');
    const modalContinueBtn = document.getElementById('modalContinueBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const resumeData = { resumeType: 'traditional' };
    let afterWarning = null;

    /* ========= Sections ========= */
    const sectionTemplates = {
      0: `
        <section class="form-section" data-section="0">
          <div class="text-center py-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome</h2>
            <p class="text-gray-500 mb-8">We’ll help you build a job-ready resume in minutes.</p>
            <button type="button" data-action="start" class="btn-primary">Start</button>
          </div>
        </section>
      `,
      1: `
        <section class="form-section" data-section="1">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b border-indigo-200/50">
            <div class="bg-indigo-100 text-indigo-600 rounded-xl p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Background</h2>
              <p class="text-gray-500">This helps us choose the right format.</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="lastJob">When did you last have a job?</label>
              <select id="lastJob" class="form-input">
                <option value="less-than-2-years">Less than 2 years ago</option>
                <option value="2-5-years">2 to 5 years ago</option>
                <option value="more-than-5-years">More than 5 years ago</option>
                <option value="first-job">This will be my first job</option>
              </select>
              <p class="text-xs text-gray-500 mt-1">Your answer helps us suggest a traditional vs. skills-based resume.</p>
            </div>

            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="ageRange">Age range (optional)</label>
              <select id="ageRange" class="form-input">
                <option value="">Prefer not to say</option>
                <option>18-24</option><option>25-34</option><option>35-44</option>
                <option>45-54</option><option>55-64</option><option>65+</option>
              </select>
            </div>

            <div class="md:col-span-2">
              <div id="resumeTypeSuggestion" class="hidden mt-1 bg-gray-50 p-4 rounded-lg border text-sm"></div>
            </div>
          </div>

          <div class="mt-8 flex justify-end">
            <button type="button" data-action="next" class="btn-primary">Next →</button>
          </div>
        </section>
      `,
      2: `
        <section class="form-section" data-section="2">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b border-indigo-200/50">
            <div class="bg-indigo-100 text-indigo-600 rounded-xl p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Contact Information</h2>
              <p class="text-gray-500">This appears at the top of your resume.</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
              <input id="fullName" required class="form-input" placeholder="John Smith" autocomplete="name"/>
            </div>

            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
              <input id="phone" required class="form-input" placeholder="(555) 123-4567" maxlength="14" inputmode="tel" autocomplete="tel"/>
              <p class="text-xs text-gray-500 mt-1">Format auto-applies as you type.</p>
            </div>

            <div class="md:col-span-2 form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
              <input id="email" type="email" required class="form-input" placeholder="john.smith@email.com" autocomplete="email"/>
            </div>

            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
              <input id="city" class="form-input" placeholder="Trenton" autocomplete="address-level2"/>
            </div>

            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
              <select id="state" class="form-input" autocomplete="address-level1"></select>
            </div>
          </div>

          <div class="mt-8 flex justify-between">
            <button type="button" data-action="prev" class="btn-secondary">← Back</button>
            <button type="button" data-action="next" class="btn-primary">Next →</button>
          </div>
        </section>
      `,
      3: `
        <section class="form-section" data-section="3">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b border-indigo-200/50">
            <div class="bg-indigo-100 text-indigo-600 rounded-xl p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Work Experience</h2>
              <p class="text-gray-500">Add your recent jobs. Use CAR (Challenge, Action, Result).</p>
            </div>
          </div>

          <div id="workExperienceContainer">
            <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-900 p-4 rounded-r-lg mb-6 text-sm">
              <div class="font-semibold">💡 CAR Tip</div>
              <ul class="list-disc list-inside mt-1">
                <li><strong>Challenge:</strong> Problem or goal</li>
                <li><strong>Action:</strong> What you did</li>
                <li><strong>Result:</strong> Outcome with numbers</li>
              </ul>
            </div>

            <div id="workExperiences" class="space-y-6"></div>
            <button type="button" data-action="addWork" class="mt-4 text-indigo-600 font-semibold hover:underline">+ Add another job</button>
          </div>

          <div id="noWorkExperienceContainer" class="hidden text-center text-gray-600 p-8 bg-gray-50 rounded-lg">
            <p>New to the workforce? No problem — we’ll focus on your skills next.</p>
          </div>

          <div class="mt-8 flex justify-between">
            <button type="button" data-action="prev" class="btn-secondary">← Back</button>
            <button type="button" data-action="next" class="btn-primary">Next →</button>
          </div>
        </section>
      `,
      4: `
        <section class="form-section" data-section="4">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b border-indigo-200/50">
            <div class="bg-indigo-100 text-indigo-600 rounded-xl p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m4 6 8-4 8 4"/><path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2"/><path d="M14 22v-4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v4"/><path d="M18 5v17"/><path d="M6 5v17"/><path d="M12 5v17"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Education</h2>
              <p class="text-gray-500">Add degrees or certificates.</p>
            </div>
          </div>

          <div id="educationEntries" class="space-y-6"></div>
          <button type="button" data-action="addEdu" class="mt-4 text-indigo-600 font-semibold hover:underline">+ Add more education</button>

          <div class="mt-8 flex justify-between">
            <button type="button" data-action="prev" class="btn-secondary">← Back</button>
            <button type="button" data-action="next" class="btn-primary">Next →</button>
          </div>
        </section>
      `,
      5: `
        <section class="form-section" data-section="5">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b border-indigo-200/50">
            <div class="bg-indigo-100 text-indigo-600 rounded-xl p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Skills</h2>
              <p class="text-gray-500">Add skills and generate strong sentences.</p>
            </div>
          </div>

          <div id="skillsList" class="space-y-5"></div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Add a skill</label>
            <div class="flex flex-col sm:flex-row gap-2">
              <input id="newSkill" class="form-input flex-grow" placeholder="e.g., Customer Service"/>
              <button type="button" data-action="addSkill" class="btn-primary sm:w-auto w-full">Add Skill</button>
            </div>
          </div>

          <div class="mt-8 flex justify-between">
            <button type="button" data-action="prev" class="btn-secondary">← Back</button>
            <button type="button" data-action="next" class="btn-primary">Next →</button>
          </div>
        </section>
      `,
      6: `
        <section class="form-section" data-section="6">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b border-indigo-200/50">
            <div class="bg-indigo-100 text-indigo-600 rounded-xl p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Review & Finalize</h2>
              <p class="text-gray-500">Check your resume, then download or email.</p>
            </div>
          </div>

          <div class="bg-gray-50 p-6 rounded-lg border shadow-inner overflow-x-auto">
            <div id="resumePreview" class="w-full max-w-[700px] mx-auto bg-white p-8"></div>
          </div>

          <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center">
            <button type="button" data-action="download" class="btn-success">📄 Download as Word (.docx)</button>
            <button type="button" data-action="email" class="btn-primary">📧 Email to TASK</button>
          </div>

          <div class="mt-6">
            <button type="button" data-action="prev" class="btn-secondary">← Edit</button>
          </div>
        </section>
      `
    };

    /* ========= Dynamic templates ========= */
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const states = ["","AL","AK","AZ","AR","CA","CO","CT","DE","DC","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];

    const workEntryTemplate = (id) => `
      <div class="entry-group bg-gray-50 p-5 rounded-xl border relative" id="work-${id}">
        <button type="button" data-action="remove" data-target="work-${id}" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl font-bold" aria-label="Remove job">&times;</button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-1">Job Title *</label>
            <input name="jobTitle" class="form-input" required placeholder="Warehouse Associate"/>
          </div>
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-1">Company *</label>
            <input name="company" class="form-input" required placeholder="Amazon"/>
          </div>
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
            <div class="flex gap-2">
              <select name="startMonth" class="form-input"></select>
              <select name="startYear" class="form-input"></select>
            </div>
          </div>
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
            <div class="flex gap-2">
              <select name="endMonth" class="form-input"></select>
              <select name="endYear" class="form-input"></select>
            </div>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Accomplishments (CAR) *</label>

            <div class="bg-indigo-50/80 border-2 border-indigo-200 rounded-lg p-3 md:p-4">
              <div class="flex items-center justify-between gap-2">
                <p class="text-sm font-medium text-indigo-900">Generate examples based on your title & company (3 at a time; re-roll for more).</p>
                <div class="flex gap-2">
                  <button type="button" data-action="generateCar" class="bg-indigo-600 text-white text-sm font-semibold py-2 px-3 rounded-md hover:bg-indigo-700">✨ Generate 3</button>
                  <button type="button" data-action="moreCar" class="bg-white text-indigo-700 text-sm font-semibold py-2 px-3 rounded-md border border-indigo-200 hover:bg-indigo-50">Show 3 more</button>
                </div>
              </div>
              <div class="car-suggestions mt-3 hidden"></div>
            </div>

            <textarea name="responsibilities" class="form-input mt-3 min-h-[220px] text-[15px] leading-6" required placeholder="• Reduced picking errors by 35% by implementing barcode scanning across 3 zones..."></textarea>
            <p class="text-xs text-gray-500 mt-1">Tip: Add 3–5 bullets. Keep each to one sentence with a number.</p>
          </div>
        </div>
      </div>
    `;

    const eduEntryTemplate = (id) => `
      <div class="entry-group bg-gray-50 p-5 rounded-xl border relative" id="edu-${id}">
        <button type="button" data-action="remove" data-target="edu-${id}" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl font-bold" aria-label="Remove education">&times;</button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
            <select name="degreeType" class="form-input" data-action="degreeTypeChange">
              <option value="High School Diploma">High School Diploma</option>
              <option value="GED">GED</option>
              <option value="Associate Degree">Associate Degree</option>
              <option value="Bachelor's Degree">Bachelor's Degree</option>
              <option value="Master's Degree">Master's Degree</option>
              <option value="Certificate">Certificate</option>
            </select>
          </div>
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-1">School *</label>
            <input name="school" class="form-input" required placeholder="Trenton Central High School"/>
          </div>

          <div class="form-group md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Degree / Certificate *</label>
            <input name="degree" class="form-input" required placeholder="e.g., General Studies"/>
            <input name="certificateName" class="form-input mt-2 hidden" placeholder="e.g., ServSafe Food Handler"/>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-1">Graduation Status</label>
            <select name="gradYear" class="form-input">
              <option value="Did not graduate">Did not graduate</option>
            </select>
          </div>

          <div class="form-group md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
            <textarea name="eduDescription" class="form-input min-h-[100px]" placeholder="Relevant coursework, honors, clubs, GPA if strong, etc."></textarea>
          </div>
        </div>
      </div>
    `;

    const skillEntryTemplate = (skill, id) => `
      <div class="entry-group bg-gray-50 p-4 rounded-xl border relative" id="skill-${id}">
        <button type="button" data-action="remove" data-target="skill-${id}" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl font-bold" aria-label="Remove skill">&times;</button>
        <div class="grid grid-cols-1 gap-2">
          <div class="text-base font-semibold text-gray-800">${skill}</div>
          <textarea name="skillDescription" class="form-input min-h-[96px] text-[15px]" placeholder="Add or generate a sentence describing this skill."></textarea>
          <div class="flex flex-wrap gap-2">
            <button type="button" data-action="generateSkillSentence" data-skill="${skill}" class="bg-indigo-600 text-white text-xs font-semibold py-2 px-3 rounded-md hover:bg-indigo-700">Generate Example Sentence</button>
            <button type="button" data-action="generateSkillSentence" data-skill="${skill}" class="bg-white text-indigo-700 text-xs font-semibold py-2 px-3 rounded-md border border-indigo-200 hover:bg-indigo-50">Generate Another</button>
          </div>
        </div>
      </div>
    `;

    /* ========= Utilities ========= */
    function styleFormElements() {
      form.querySelectorAll('input, textarea, select').forEach(el=>{
        if (!el.classList.contains('form-input')) {
          el.classList.add('form-input','w-full','px-3','py-2.5','border','border-gray-300','rounded-md','shadow-sm','focus:outline-none','focus:ring-2','focus:ring-indigo-500','focus:border-indigo-500','transition');
        }
      });
      form.querySelectorAll('.btn-primary, .btn-secondary, .btn-success').forEach(btn=>{
        if (btn.dataset.styled) return;
        btn.dataset.styled = true;
        const base = 'inline-flex items-center justify-center px-6 py-3 border text-base font-semibold rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform hover:scale-[1.02]';
        if (btn.classList.contains('btn-primary')) btn.className = `btn-primary ${base} border-transparent text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500`;
        if (btn.classList.contains('btn-secondary')) btn.className = `btn-secondary ${base} border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:ring-indigo-500`;
        if (btn.classList.contains('btn-success')) btn.className = `btn-success ${base} w-full sm:w-auto border-transparent text-white bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500`;
      });
    }
    const escapeHtml = (s='') => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    function updateProgress(){ progressBar.style.width = Math.max(0, Math.min(100, (currentSection/6)*100)) + '%'; }

    function goToSection(n){
      if (n < 0 || n > 6) return;
      const cur = form.querySelector(`.form-section[data-section="${currentSection}"]`); if (cur) cur.classList.remove('active');
      let next = form.querySelector(`.form-section[data-section="${n}"]`);
      if (!next) { form.insertAdjacentHTML('beforeend', sectionTemplates[n]); next = form.querySelector(`.form-section[data-section="${n}"]`);
        if (n === 1) updateResumeTypeSuggestion(document.getElementById('lastJob').value);
        if (n === 2) populateStates();
        if (n === 3) {
          if (resumeData.resumeType === 'traditional') {
            addDynamicEntry('workExperiences', workEntryTemplate);
            document.getElementById('workExperienceContainer').classList.remove('hidden');
            document.getElementById('noWorkExperienceContainer').classList.add('hidden');
          } else {
            document.getElementById('workExperienceContainer').classList.add('hidden');
            document.getElementById('noWorkExperienceContainer').classList.remove('hidden');
          }
        }
        if (n === 4) addDynamicEntry('educationEntries', eduEntryTemplate);
      }
      currentSection = n; next.classList.add('active'); updateProgress(); window.scrollTo({top:0, behavior:'smooth'}); if (n===6) generatePreview(); styleFormElements();
    }

    function addDynamicEntry(containerId, templateFn){
      const container = document.getElementById(containerId); if (!container) return;
      const id = Date.now() + Math.floor(Math.random()*1000);
      container.insertAdjacentHTML('beforeend', templateFn(id));
      const group = document.getElementById(container.lastElementChild?.id);
      if (containerId==='workExperiences') populateDateDropdowns(group);
      if (containerId==='educationEntries') populateGradYearDropdown(group);
      styleFormElements();
    }

    function populateStates(){
      const sel = document.getElementById('state');
      if (!sel || sel.options.length) return;
      states.forEach(s => sel.innerHTML += `<option value="${s}">${s ? s : 'Select'}</option>`);
    }

    function populateDateDropdowns(container){
      const currentYear = new Date().getFullYear();
      const startY = container.querySelector('select[name="startYear"]');
      const endY   = container.querySelector('select[name="endYear"]');
      const startM = container.querySelector('select[name="startMonth"]');
      const endM   = container.querySelector('select[name="endMonth"]');
      if (startY) { startY.innerHTML = '<option value="">Year</option>'; for (let y=currentYear; y>=currentYear-70; y--) startY.innerHTML += `<option>${y}</option>`; }
      if (endY)   { endY.innerHTML   = '<option value="">Year</option><option>Present</option>'; for (let y=currentYear; y>=currentYear-70; y--) endY.innerHTML += `<option>${y}</option>`; }
      if (startM) startM.innerHTML = '<option value="">Month</option>' + months.map(m=>`<option>${m}</option>`).join('');
      if (endM)   endM.innerHTML   = '<option value="">Month</option>' + months.map(m=>`<option>${m}</option>`).join('');
    }
    function populateGradYearDropdown(container){
      const currentYear = new Date().getFullYear();
      const sel = container.querySelector('select[name="gradYear"]');
      if (sel) for (let y=currentYear+1; y>=currentYear-70; y--) sel.innerHTML += `<option>${y}</option>`;
    }

    function validateSection(n){
      const section = form.querySelector(`.form-section[data-section="${n}"]`); if (!section) return true;
      section.querySelectorAll('[required]:not(:disabled)').forEach(el => { el.classList.remove('ring-2','ring-red-500','border-red-500'); el.closest('.form-group')?.querySelector('.error-message')?.remove(); });
      let ok = true;
      section.querySelectorAll('[required]:not(:disabled)').forEach(el => {
        if (!String(el.value||'').trim()) {
          ok=false; el.classList.add('ring-2','ring-red-500','border-red-500');
          const p=document.createElement('p'); p.className='error-message text-xs text-red-600 mt-1'; p.textContent='This field is required.'; (el.closest('.form-group')||el.parentElement).appendChild(p);
        }
      });
      return ok;
    }

    function updateResumeTypeSuggestion(v){
      const box=document.getElementById('resumeTypeSuggestion');
      if (v==='more-than-5-years' || v==='first-job'){ resumeData.resumeType='skills-based'; box.innerHTML='<strong>Recommended: Skills-Based.</strong> We’ll emphasize your abilities and training.'; }
      else { resumeData.resumeType='traditional'; box.innerHTML='<strong>Recommended: Traditional (Chronological).</strong> Best when your work history is recent.'; }
      box.classList.remove('hidden');
    }

    /* ========= Generators ========= */
    // Domain-aware keyword sets for better relevance
    const domainMap = [
      {keys:["warehouse","picker","pack","forklift","logistics"], challenges:["inventory inaccuracies","equipment downtime","slow picking routes","damaged shipments","safety incidents"], actions:["optimized pick paths","introduced barcode checks","trained new hires on RF scanners","standardized pallet labeling","implemented 5S"], metrics:["throughput %","errors %","on-time shipments %","injuries %","units/hour"]},
      {keys:["customer service","call center","csr","front desk","reception"], challenges:["long wait times","repeat escalations","incomplete tickets","unclear scripts"], actions:["created quick-reply templates","triaged tickets by priority","documented resolutions","trained peers on de-escalation"], metrics:["first-contact resolution %","AHT %","CSAT pts","escalations %"]},
      {keys:["retail","cashier","sales associate"], challenges:["long checkout lines","out-of-stock items","poor merchandising"], actions:["rebalanced staffing at peak","built facing/zone routines","created restock checklist"], metrics:["transactions/hour","shrink %","upsell rate %","revenue %"]},
      {keys:["cook","kitchen","server","food","barista"], challenges:["ticket backlog","food waste","inconsistent portions"], actions:["prepped to par levels","batch-prepped bottlenecks","introduced station checklists"], metrics:["ticket time %","waste %","guest satisfaction pts"]},
      {keys:["driver","delivery","courier"], challenges:["missed delivery windows","route inefficiency","damaged items"], actions:["optimized routes","verified loads vs. manifest","created proof-of-delivery routine"], metrics:["on-time rate %","miles saved %","claims %"]},
      {keys:["housekeeping","custodian","janitor"], challenges:["low inspection scores","supply overuse","missed zones"], actions:["zoned task lists","color-coded supplies","end-of-shift audit"], metrics:["inspection score pts","supply cost %","complaints %"]},
      {keys:["admin","assistant","office","clerk"], challenges:["missed deadlines","disorganized files","meeting conflicts"], actions:["calendar SOP","shared digital filing","automated reminders"], metrics:["on-time completion %","processing time %","errors %"]},
      {keys:["maintenance","janitorial","tech","mechanic"], challenges:["unplanned downtime","late PMs","repeat failures"], actions:["PM calendar","spare-parts matrix","root-cause logs"], metrics:["uptime %","response time %","repeat calls %"]}
    ];

    function detectDomain(title){
      const t = (title||'').toLowerCase();
      return domainMap.find(d => d.keys.some(k => t.includes(k))) || null;
    }

    function rand(seed){ // stable-ish but varied
      let x = Math.sin(seed) * 10000; return x - Math.floor(x);
    }

    function carExamples(title, company, offset=0){
      const dom = detectDomain(title);
      const base = (title + '|' + company + '|' + offset).split('').reduce((a,c)=>a + c.charCodeAt(0), 0) || 7;
      const arr = [];
      for (let i=0;i<3;i++){
        const r1 = rand(base+i*13+1), r2 = rand(base+i*13+2), r3 = rand(base+i*13+3);
        let ch, act, metricName;
        if (dom){
          ch = dom.challenges[Math.floor(r1*dom.challenges.length)];
          act = dom.actions[Math.floor(r2*dom.actions.length)];
          metricName = dom.metrics[Math.floor(r3*dom.metrics.length)];
        } else {
          ch = ["process delays","manual errors","unclear handoffs","schedule gaps"][Math.floor(r1*4)];
          act = ["standardized a checklist","created a tracking sheet","coordinated with the team lead","introduced a daily huddle"][Math.floor(r2*4)];
          metricName = ["time %","errors %","throughput %","satisfaction pts"][Math.floor(r3*4)];
        }
        const value = 10 + Math.floor(rand(base+i*7+9)*36); // 10..45
        const metric = metricName.includes("pts") ? `${value} pts` : `${value}%`;
        arr.push(`• Faced ${ch} at ${company}; ${act} as ${title}, improving ${metricName.replace(' %','').replace(' pts','')} by ${metric}.`);
      }
      return arr;
    }

    const skillStarters = ["Applied","Demonstrated","Leveraged","Utilized","Strengthened","Implemented","Consistently practiced"];
    const skillContexts = ["in fast-paced environments","serving diverse customers","across cross-functional teams","with minimal supervision","while meeting safety and quality standards","during peak-demand periods","within SLA targets","in high-volume operations"];
    const skillActions = ["to solve operational problems quickly","to improve task accuracy","to support team goals","to reduce rework and delays","to streamline daily workflows","to maintain compliance with SOPs","to boost service quality","to meet or exceed daily targets"];
    const skillOutcomes = ["cutting errors by","increasing throughput by","reducing wait times by","raising satisfaction scores by","improving on-time completion by","reducing escalations by","shortening training time by","improving first-pass yield by"];
    function generateSkillSentence(skill){
      const r = Math.random;
      const v = 10 + Math.floor(r()*36);
      return `${skillStarters[Math.floor(r()*skillStarters.length)]} ${skill.toLowerCase()} ${skillContexts[Math.floor(r()*skillContexts.length)]} ${skillActions[Math.floor(r()*skillActions.length)]}, ${skillOutcomes[Math.floor(r()*skillOutcomes.length)]} ${v}%.`;
    }

    /* ========= Preview / Export / Email ========= */
    function collectData(){
      const data = {
        type: resumeData.resumeType,
        name: document.getElementById('fullName')?.value?.trim() || '',
        phone: document.getElementById('phone')?.value?.trim() || '',
        email: document.getElementById('email')?.value?.trim() || '',
        city: document.getElementById('city')?.value?.trim() || '',
        state: document.getElementById('state')?.value || '',
        work: [], education: [], skills: []
      };
      document.querySelectorAll('#workExperiences .entry-group').forEach(g=>{
        const q = n => g.querySelector(`[name="${n}"]`)?.value?.trim() || '';
        const title=q('jobTitle'), company=q('company'), sm=q('startMonth'), sy=q('startYear'), em=q('endMonth'), ey=q('endYear'), bullets=q('responsibilities');
        if (title || company || bullets) data.work.push({title, company, start:`${sm||''} ${sy||''}`.trim(), end:`${em||''} ${ey||''}`.trim(), bullets});
      });
      document.querySelectorAll('#educationEntries .entry-group').forEach(g=>{
        const q=n=>g.querySelector(`[name="${n}"]`)?.value?.trim() || '';
        const type=q('degreeType'), school=q('school');
        const degree = type==='Certificate' ? (q('certificateName') || q('degree')) : q('degree');
        const education = { type, school, degree, gradYear:q('gradYear'), desc:q('eduDescription') };
        if (school || degree) data.education.push(education);
      });
      document.querySelectorAll('#skillsList .entry-group').forEach(g=>{
        const skill = g.querySelector('div.text-base')?.textContent?.trim();
        const sent = g.querySelector('textarea[name="skillDescription"]')?.value?.trim() || '';
        if (skill) data.skills.push({skill, sent});
      });
      return data;
    }

    function generatePreview(){
      const d = collectData();
      const wrap = document.getElementById('resumePreview'); const parts=[];
      parts.push(`<h3>${escapeHtml(d.name || 'Your Name')}</h3>`);
      const loc = [d.city, d.state].filter(Boolean).join(', ');
      const contact = [loc, d.phone, d.email].filter(Boolean).join(' | ');
      parts.push(`<div class="contact-info">${escapeHtml(contact)}</div>`);

      if (d.type==='skills-based' && d.skills.length){
        parts.push(`<h4>Skills</h4><ul>${d.skills.map(s=>`<li><strong>${escapeHtml(s.skill)}:</strong> ${escapeHtml(s.sent)}</li>`).join('')}</ul>`);
      }

      if (d.work.length && d.type==='traditional'){
        parts.push('<h4>Experience</h4>');
        d.work.forEach(w=>{
          const bullets = (w.bullets||'').split(/\n|•/).filter(Boolean).map(b=>`<li>${escapeHtml(b.trim())}</li>`).join('');
          parts.push(`<div class="entry"><div class="entry-header"><div class="title">${escapeHtml(w.title)} — ${escapeHtml(w.company)}</div><div class="meta">${escapeHtml((w.start||'').trim())}${w.end? ' — '+escapeHtml((w.end||'').trim()):''}</div></div>${bullets? `<ul>${bullets}</ul>`:''}</div>`);
        });
      }

      if (d.education.length){
        parts.push('<h4>Education</h4>');
        d.education.forEach(e=>{
          const line=`${escapeHtml(e.degree)} — ${escapeHtml(e.school)}`;
          parts.push(`<div class="entry"><div class="entry-header"><div class="title">${line}</div><div class="meta">${escapeHtml(e.gradYear||'')}</div></div>${e.desc? `<div class="mt-1 text-sm">${escapeHtml(e.desc)}</div>`:''}</div>`);
        });
      }

      if (d.type==='skills-based' && d.work.length){
        parts.push('<h4>Experience</h4>');
        d.work.forEach(w=>{
          const bullets = (w.bullets||'').split(/\n|•/).filter(Boolean).map(b=>`<li>${escapeHtml(b.trim())}</li>`).join('');
          parts.push(`<div class="entry"><div class="entry-header"><div class="title">${escapeHtml(w.title)} — ${escapeHtml(w.company)}</div><div class="meta">${escapeHtml((w.start||'').trim())}${w.end? ' — '+escapeHtml((w.end||'').trim()):''}</div></div>${bullets? `<ul>${bullets}</ul>`:''}</div>`);
        });
      }

      if (d.type==='traditional' && d.skills.length){
        parts.push(`<h4>Skills</h4><ul>${d.skills.map(s=>`<li><strong>${escapeHtml(s.skill)}:</strong> ${escapeHtml(s.sent)}</li>`).join('')}</ul>`);
      }
      wrap.innerHTML = parts.join('');
    }

    async function downloadDocx(){
      const d = collectData();
      const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;
      const children=[];
      children.push(new Paragraph({ alignment: AlignmentType.CENTER, children:[ new TextRun({text:d.name || 'Your Name', bold:true, size:48}) ] }));
      const contact=[ [d.city,d.state].filter(Boolean).join(', '), d.phone, d.email ].filter(Boolean).join(' | ');
      if (contact) children.push(new Paragraph({ alignment: AlignmentType.CENTER, children:[ new TextRun({text:contact, italics:true, size:20}) ] }));
      const H = t => children.push(new Paragraph({ text:t.toUpperCase(), heading: HeadingLevel.HEADING_3 }));

      if (resumeData.resumeType==='skills-based' && d.skills.length){ H('Skills'); d.skills.forEach(s=>children.push(new Paragraph({ children:[ new TextRun({ text:`${s.skill}: ${s.sent}`, size:22 }) ] }))); }
      if (d.work.length){ H('Experience'); d.work.forEach(w=>{ const l1=`${w.title || ''}${(w.title&&w.company)?' — ':''}${w.company||''}`; const l2=`${(w.start||'').trim()}${w.end? ' — '+(w.end||'').trim() : ''}`; if (l1.trim()) children.push(new Paragraph({ children:[ new TextRun({text:l1, bold:true, size:24}) ] })); if (l2.trim()) children.push(new Paragraph({ children:[ new TextRun({text:l2, italics:true, size:20}) ] })); (w.bullets||'').split(/\n|•/).filter(Boolean).forEach(b=>children.push(new Paragraph({ children:[ new TextRun({ text:'• '+b.trim(), size:22 }) ] }))); }); }
      if (d.education.length){ H('Education'); d.education.forEach(e=>{ const l1=`${e.degree || ''}${(e.degree && e.school)?' — ':''}${e.school || ''}`; if (l1.trim()) children.push(new Paragraph({ children:[ new TextRun({text:l1, bold:true, size:24}) ] })); if ((e.gradYear||'').trim()) children.push(new Paragraph({ children:[ new TextRun({text:e.gradYear, italics:true, size:20}) ] })); if (e.desc) children.push(new Paragraph({ children:[ new TextRun({text:e.desc, size:22}) ] })); }); }
      if (resumeData.resumeType==='traditional' && d.skills.length){ H('Skills'); d.skills.forEach(s=>children.push(new Paragraph({ children:[ new TextRun({ text:`${s.skill}: ${s.sent}`, size:22 }) ] }))); }

      const doc = new Document({ sections:[{ children }] });
      const blob = await Packer.toBlob(doc);
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (d.name? d.name.replace(/\s+/g,'_'):'resume')+'.docx'; a.click(); URL.revokeObjectURL(a.href);
    }

    function composeEmailBody(){
      const d = collectData(); const out=[];
      out.push((d.name || 'Your Name'));
      const contact=[ [d.city,d.state].filter(Boolean).join(', '), d.phone, d.email ].filter(Boolean).join(' | ');
      if (contact) out.push(contact); out.push('');

      const pushBullets = s => (s||'').split(/\n|•/).filter(Boolean).forEach(b=>out.push('• '+b.trim()));

      if (resumeData.resumeType==='skills-based' && d.skills.length){ out.push('SKILLS:'); d.skills.forEach(s=>out.push(`- ${s.skill}: ${s.sent}`)); out.push(''); }
      if (d.work.length){ out.push('EXPERIENCE:'); d.work.forEach(w=>{ out.push(`${w.title || ''}${(w.title&&w.company)?' — ':''}${w.company || ''}`); const dates=`${(w.start||'').trim()}${w.end?' — '+(w.end||'').trim():''}`; if (dates.trim()) out.push(dates); pushBullets(w.bullets); out.push(''); }); }
      if (d.education.length){ out.push('EDUCATION:'); d.education.forEach(e=>{ out.push(`${e.degree || ''}${(e.degree&&e.school)?' — ':''}${e.school || ''}`); if (e.gradYear) out.push(e.gradYear); if (e.desc) out.push(e.desc); out.push(''); }); }
      if (resumeData.resumeType==='traditional' && d.skills.length){ out.push('SKILLS:'); d.skills.forEach(s=>out.push(`- ${s.skill}: ${s.sent}`)); out.push(''); }
      return out.join('%0D%0A');
    }

    /* ========= Incomplete check + modal ========= */
    function isIncomplete(){
      const d = collectData();
      const hasContact = !!d.name && !!d.email;
      const hasContent = (d.work?.length || d.education?.length || d.skills?.length);
      return !(hasContact && hasContent);
    }
    function showWarning(onContinue){ afterWarning = onContinue||null; modal.style.display='block'; }
    function hideWarning(){ modal.style.display='none'; afterWarning=null; }
    modalContinueBtn.addEventListener('click', ()=>{ const next=afterWarning; hideWarning(); if (typeof next==='function') next(); });
    modalCancelBtn.addEventListener('click', hideWarning);

    /* ========= Events ========= */
    form.addEventListener('click', e=>{
      const action = e.target.dataset.action; if (!action) return;

      const actions = {
        start: ()=> goToSection(1),
        next: ()=> { if (validateSection(currentSection)) goToSection(currentSection+1); },
        prev: ()=> goToSection(currentSection-1),
        addWork: ()=> addDynamicEntry('workExperiences', workEntryTemplate),
        addEdu: ()=> addDynamicEntry('educationEntries', eduEntryTemplate),
        remove: ()=> document.getElementById(e.target.dataset.target)?.remove(),
        generateCar: ()=> handleCar(e, 0),
        moreCar: ()=> handleCar(e, Math.floor(Math.random()*100000)),
        addSkill: ()=>{
          const input=document.getElementById('newSkill'); const skill=(input.value||'').trim();
          if (skill){ const id=Date.now(); document.getElementById('skillsList').insertAdjacentHTML('beforeend', skillEntryTemplate(skill, id)); input.value=''; styleFormElements(); }
        },
        generateSkillSentence: ()=>{
          const skill = e.target.dataset.skill;
          const area = e.target.closest('.entry-group')?.querySelector('textarea[name="skillDescription"]');
          if (area) area.value = generateSkillSentence(skill);
        },
        download: ()=>{
          const proceed = ()=> downloadDocx();
          if (isIncomplete()) showWarning(proceed); else proceed();
        },
        email: ()=>{
          const proceed = ()=>{
            const subject = encodeURIComponent('Resume Submission');
            const body = composeEmailBody();
            window.location.href = `mailto:EandE@trentonsoupkitchen.org?subject=${subject}&body=${body}`;
          };
          if (isIncomplete()) showWarning(proceed); else proceed();
        }
      };
      if (actions[action]) actions[action]();
    });

    form.addEventListener('change', e=>{
      if (e.target.id==='lastJob') updateResumeTypeSuggestion(e.target.value);
      if (e.target.dataset.action==='degreeTypeChange'){
        const g=e.target.closest('.entry-group'); const deg=g.querySelector('[name="degree"]'); const cert=g.querySelector('[name="certificateName"]');
        if (e.target.value==='Certificate'){ cert.classList.remove('hidden'); deg.placeholder='e.g., General Certificate'; } else { cert.classList.add('hidden'); deg.placeholder='e.g., B.S. in Marketing'; }
      }
    });

    form.addEventListener('input', e=>{
      if (e.target.id==='phone'){
        let x=e.target.value.replace(/\D/g,'').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
        e.target.value = !x[2] ? x[1] : '('+x[1]+') '+x[2]+(x[3]?'-'+x[3]:'');
      }
    });

    function handleCar(ev, offset){
      const grp = ev.target.closest('.entry-group'); if (!grp) return;
      const title = grp.querySelector('[name="jobTitle"]')?.value?.trim() || 'Team Member';
      const company = grp.querySelector('[name="company"]')?.value?.trim() || 'Company';
      const target = grp.querySelector('.car-suggestions');
      const bullets = carExamples(title, company, offset).map(b => `
          <button type="button" class="block text-left w-full bg-white border border-indigo-100 rounded-md px-3 py-2 hover:bg-indigo-50 select-bullet">${escapeHtml(b)}</button>
      `).join('');
      target.innerHTML = `<div class="space-y-2">${bullets}</div>`;
      target.classList.remove('hidden');
      target.querySelectorAll('.select-bullet').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const area = grp.querySelector('textarea[name="responsibilities"]');
          const val = btn.textContent.trim();
          area.value = (area.value ? area.value + '\n' : '') + val;
          area.focus();
        });
      });
    }

    /* ========= Boot ========= */
    form.innerHTML = sectionTemplates[0]; styleFormElements(); goToSection(0);
    new MutationObserver(styleFormElements).observe(form, { childList:true, subtree:true });
  </script>
</body>
</html>
