<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TASK Resume Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- Word export -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <style>
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; }
    .form-section { display: none; animation: fadeIn 0.35s ease-in-out; }
    .form-section.active { display: block; }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(14px);} to {opacity: 1; transform: translateY(0);} }
    /* Classic resume preview styles */
    #resumePreview { font-family: 'Times New Roman', Times, serif; color: #1a202c; }
    #resumePreview h3 { font-size: 24px; font-weight:700; text-align:center; margin-bottom:4px; }
    #resumePreview .contact-info { font-size:12px; text-align:center; color:#4a5568; margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid #2d3748; }
    #resumePreview h4 { font-size:16px; font-weight:700; text-transform:uppercase; margin-top:16px; margin-bottom:8px; border-bottom:1px solid #4a5568; padding-bottom:4px; }
    #resumePreview .entry { margin-bottom:12px; }
    #resumePreview .entry-header { display:flex; justify-content:space-between; align-items:baseline; }
    #resumePreview .title { font-weight:700; font-size:14px; }
    #resumePreview .meta { font-style:italic; font-size:13px; color:#4a5568; }
    #resumePreview ul { list-style-position:outside; padding-left:20px; margin-top:4px; }
    #resumePreview li { font-size:13px; margin-bottom:4px; line-height:1.6; color:#2d3748; }
    #resumePreview .skills-list { font-size:13px; line-height:1.6; }
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); }
  </style>
</head>
<body class="bg-gray-100">

  <div class="min-h-screen bg-gradient-to-br from-purple-600 to-indigo-700 p-4 sm:p-6 lg:p-8 flex items-center justify-center">
    <div class="container w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">

      <!-- Header -->
      <header class="bg-gradient-to-br from-purple-600 to-indigo-700 text-white p-6 sm:p-8 text-center">
        <h1 class="text-3xl sm:text-4xl font-bold flex items-center justify-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M15.5 2H8.6c-.4 0-.8.2-1.1.5-.3.3-.5.7-.5 1.1V21c0 .8.7 1.5 1.5 1.5h8c.8 0 1.5-.7 1.5-1.5V6.5L15.5 2z"/><path d="M15 2v5h5"/><path d="M10 16s-1 1-2 1-2-1-2-1"/><path d="M10 12s-1 1-2 1-2-1-2-1"/><path d="m14 12 4 4"/><path d="m18 12-4 4"/></svg>
          TASK Resume Builder
        </h1>
        <p class="mt-2 text-indigo-200 text-lg">Build your professional resume step-by-step</p>
        <!-- Progress bar -->
        <div class="mt-6 bg-black/20 h-2.5 rounded-full overflow-hidden">
          <div id="progressBar" class="bg-white h-full rounded-full transition-all duration-500 ease-out" style="width:0%;"></div>
        </div>
      </header>

      <!-- Content -->
      <main class="p-6 sm:p-8">
        <form id="resumeForm"></form>
      </main>
    </div>
  </div>

  <!-- Warning Modal -->
  <div id="warningModal" class="modal-overlay flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-auto text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
        <svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M4.07 19h15.86c1.54 0 2.5-1.67 1.73-3L13.73 4c-.77-1.33-2.69-1.33-3.46 0L2.34 16c-.77 1.33.19 3 1.73 3z"/></svg>
      </div>
      <h3 class="text-lg font-bold text-gray-900 mt-3">Resume may be incomplete</h3>
      <p class="text-sm text-gray-600 mt-2">We didnâ€™t find enough info to build a solid resume. Do you still want to continue?</p>
      <div class="mt-5 flex gap-3 justify-center">
        <button type="button" id="modalContinueBtn" class="px-6 py-3 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 font-semibold">Continue anyway</button>
        <button type="button" id="modalCancelBtn" class="px-6 py-3 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold">Go back & edit</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- State ----------
    let currentSection = 0; // 0 = Splash
    const totalSections = 6; // 0..6 inclusive
    const form = document.getElementById('resumeForm');
    const progressBar = document.getElementById('progressBar');
    const modal = document.getElementById('warningModal');
    const resumeData = { resumeType: 'traditional' };

    // ---------- Templates ----------
    const sectionTemplates = {
      0: `
        <section class="form-section" data-section="0">
          <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome</h2>
            <p class="text-gray-500 mb-8">Weâ€™ll help you create a job-ready resume in minutes.</p>
            <button type="button" data-action="start" class="btn-primary">Start</button>
          </div>
        </section>
      `,
      1: `
        <section class="form-section" data-section="1">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b-2 border-indigo-200">
            <div class="bg-indigo-100 text-indigo-600 rounded-lg p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Demographic & Background</h2>
              <p class="text-gray-500">This helps us format the right resume for you.</p>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group">
              <label class="block text-sm font-semibold text-gray-700 mb-1" for="lastJob">When did you last have a job?</label>
              <select id="lastJob" class="form-input">
                <option value="less-than-2-years">Less than 2 years ago</option>
                <option value="2-5-years">2 to 5 years ago</option>
                <option value="more-than-5-years">More than 5 years ago</option>
                <option value="first-job">This will be my first job</option>
              </select>
            </div>
            <div class="form-group">
              <label class="block text-sm font-semibold text-gray-700 mb-1" for="ageRange">Age range (optional)</label>
              <select id="ageRange" class="form-input">
                <option value="">Prefer not to say</option>
                <option>18-24</option><option>25-34</option><option>35-44</option>
                <option>45-54</option><option>55-64</option><option>65+</option>
              </select>
            </div>
            <div class="form-group md:col-span-2">
              <div id="resumeTypeSuggestion" class="mt-1 bg-gray-50 p-4 rounded-lg border hidden"></div>
            </div>
          </div>
          <div class="mt-8 flex justify-end">
            <button type="button" data-action="next" class="btn-primary">Next &rarr;</button>
          </div>
        </section>
      `,
      2: `
        <section class="form-section" data-section="2">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b-2 border-indigo-200">
            <div class="bg-indigo-100 text-indigo-600 rounded-lg p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Contact Information</h2>
              <p class="text-gray-500">Weâ€™ll use this at the top of your resume.</p>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group"><label class="block text-sm font-semibold text-gray-700 mb-1">Full Name *</label><input id="fullName" required class="form-input" placeholder="John Smith"/></div>
            <div class="form-group"><label class="block text-sm font-semibold text-gray-700 mb-1">Phone Number *</label><input id="phone" required class="form-input" placeholder="(555) 123-4567" maxlength="14"/></div>
            <div class="form-group md:col-span-2"><label class="block text-sm font-semibold text-gray-700 mb-1">Email Address *</label><input id="email" required type="email" class="form-input" placeholder="john.smith@email.com"/></div>
            <div class="form-group md:col-span-2"><label class="block text-sm font-semibold text-gray-700 mb-1">City, State</label><input id="location" class="form-input" placeholder="Trenton, NJ"/></div>
          </div>
          <div class="mt-8 flex justify-between">
            <button type="button" data-action="prev" class="btn-secondary">&larr; Back</button>
            <button type="button" data-action="next" class="btn-primary">Next &rarr;</button>
          </div>
        </section>
      `,
      3: `
        <section class="form-section" data-section="3">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b-2 border-indigo-200">
            <div class="bg-indigo-100 text-indigo-600 rounded-lg p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Work Experience</h2>
              <p class="text-gray-500">Add your recent jobs. Use CAR (Challenge, Action, Result).</p>
            </div>
          </div>

          <div id="workExperienceContainer">
            <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg mb-6">
              <h4 class="font-bold">ðŸ’¡ CAR Tip</h4>
              <ul class="list-disc list-inside mt-1 text-sm">
                <li><strong>Challenge:</strong> Problem or goal</li>
                <li><strong>Action:</strong> What you did</li>
                <li><strong>Result:</strong> Outcome with numbers</li>
              </ul>
            </div>
            <div id="workExperiences" class="space-y-6"></div>
            <button type="button" data-action="addWork" class="mt-4 text-indigo-600 font-semibold hover:underline">+ Add Another Job</button>
          </div>

          <div id="noWorkExperienceContainer" class="hidden text-center text-gray-600 p-8 bg-gray-50 rounded-lg">
            <p>No problem â€” weâ€™ll focus on your skills instead. Continue to the next step.</p>
          </div>

          <div class="mt-8 flex justify-between">
            <button type="button" data-action="prev" class="btn-secondary">&larr; Back</button>
            <button type="button" data-action="next" class="btn-primary">Next &rarr;</button>
          </div>
        </section>
      `,
      4: `
        <section class="form-section" data-section="4">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b-2 border-indigo-200">
            <div class="bg-indigo-100 text-indigo-600 rounded-lg p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m4 6 8-4 8 4"/><path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2"/><path d="M14 22v-4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v4"/><path d="M18 5v17"/><path d="M6 5v17"/><path d="M12 5v17"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Education</h2>
              <p class="text-gray-500">List your degrees or certificates.</p>
            </div>
          </div>

          <div id="educationEntries" class="space-y-6"></div>
          <button type="button" data-action="addEdu" class="mt-4 text-indigo-600 font-semibold hover:underline">+ Add More Education</button>

          <div class="mt-8 flex justify-between">
            <button type="button" data-action="prev" class="btn-secondary">&larr; Back</button>
            <button type="button" data-action="next" class="btn-primary">Next &rarr;</button>
          </div>
        </section>
      `,
      5: `
        <section class="form-section" data-section="5">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b-2 border-indigo-200">
            <div class="bg-indigo-100 text-indigo-600 rounded-lg p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Skills</h2>
              <p class="text-gray-500">Add skills and generate strong sentences.</p>
            </div>
          </div>

          <div id="skillsList" class="space-y-4"></div>

          <div class="mt-4">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Add a Skill</label>
            <div class="flex gap-2">
              <input id="newSkill" class="form-input flex-grow" placeholder="e.g., Customer Service"/>
              <button type="button" data-action="addSkill" class="btn-primary whitespace-nowrap">Add Skill</button>
            </div>
          </div>

          <div class="mt-8 flex justify-between">
            <button type="button" data-action="prev" class="btn-secondary">&larr; Back</button>
            <button type="button" data-action="next" class="btn-primary">Next &rarr;</button>
          </div>
        </section>
      `,
      6: `
        <section class="form-section" data-section="6">
          <div class="flex items-start gap-4 mb-6 pb-4 border-b-2 border-indigo-200">
            <div class="bg-indigo-100 text-indigo-600 rounded-lg p-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Review & Finalize</h2>
              <p class="text-gray-500">Check your resume, then download or email.</p>
            </div>
          </div>

          <div class="bg-gray-50 p-6 rounded-lg border shadow-inner overflow-x-auto">
            <div id="resumePreview" class="w-full max-w-[700px] mx-auto bg-white p-8"></div>
          </div>

          <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center">
            <button type="button" data-action="download" class="btn-success">ðŸ“„ Download as Word (.docx)</button>
            <button type="button" data-action="email" class="btn-primary">ðŸ“§ Email to TASK</button>
          </div>

          <div class="mt-6">
            <button type="button" data-action="prev" class="btn-secondary">&larr; Edit Resume</button>
          </div>
        </section>
      `
    };

    // ---------- Dynamic entry templates ----------
    const workEntryTemplate = (id) => `
      <div class="entry-group bg-gray-50 p-5 rounded-lg border relative" id="work-${id}">
        <button type="button" data-action="remove" data-target="work-${id}" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Job Title *</label>
            <input name="jobTitle" class="form-input" required placeholder="Warehouse Associate"/>
          </div>
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Company *</label>
            <input name="company" class="form-input" required placeholder="ABC Logistics"/>
          </div>
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Start Date</label>
            <div class="flex gap-2">
              <select name="startMonth" class="form-input"></select>
              <select name="startYear" class="form-input"></select>
            </div>
          </div>
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-1">End Date</label>
            <div class="flex gap-2">
              <select name="endMonth" class="form-input"></select>
              <select name="endYear" class="form-input"></select>
            </div>
          </div>
          <div class="form-group md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Accomplishments (CAR) *</label>
            <div class="bg-indigo-50 border-2 border-indigo-400 border-dashed p-4 rounded-lg mb-2">
              <p class="text-sm font-semibold text-indigo-800 mb-2">Generate examples based on your title & company (3 at a time; re-roll for more).</p>
              <div class="flex gap-2">
                <button type="button" data-action="generateCar" class="w-full bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600">âœ¨ Generate 3 Examples</button>
                <button type="button" data-action="moreCar" class="whitespace-nowrap bg-indigo-100 text-indigo-700 font-semibold py-2 px-3 rounded-md hover:bg-indigo-200">Show 3 more</button>
              </div>
              <div class="car-suggestions mt-3 hidden"></div>
            </div>
            <textarea name="responsibilities" class="form-input min-h-[140px]" required placeholder="â€¢ Reduced picking errors by 35% by implementing barcode scanning across 3 zones..."></textarea>
          </div>
        </div>
      </div>
    `;

    const eduEntryTemplate = (id) => `
      <div class="entry-group bg-gray-50 p-5 rounded-lg border relative" id="edu-${id}">
        <button type="button" data-action="remove" data-target="edu-${id}" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Type *</label>
            <select name="degreeType" class="form-input" data-action="degreeTypeChange">
              <option value="High School Diploma">High School Diploma</option>
              <option value="GED">GED</option>
              <option value="Associate Degree">Associate Degree</option>
              <option value="Bachelor's Degree">Bachelor's Degree</option>
              <option value="Master's Degree">Master's Degree</option>
              <option value="Certificate">Certificate</option>
            </select>
          </div>
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-1">School *</label>
            <input name="school" class="form-input" required placeholder="Trenton Central High School"/>
          </div>

          <div class="form-group md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Degree / Certificate *</label>
            <input name="degree" class="form-input" required placeholder="e.g., General Studies"/>
            <input name="certificateName" class="form-input mt-2 hidden" placeholder="e.g., ServSafe Food Handler"/>
          </div>

          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Graduation Status</label>
            <select name="gradYear" class="form-input">
              <option value="Did not graduate">Did not graduate</option>
            </select>
          </div>

          <div class="form-group md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Description (Optional)</label>
            <textarea name="eduDescription" class="form-input" placeholder="Relevant coursework, honors, etc."></textarea>
          </div>
        </div>
      </div>
    `;

    const skillEntryTemplate = (skill, id) => `
      <div class="entry-group bg-gray-50 p-4 rounded-lg border relative" id="skill-${id}">
        <button type="button" data-action="remove" data-target="skill-${id}" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
        <p class="font-bold text-gray-800">${skill}</p>
        <div class="mt-2 space-y-2">
          <textarea name="skillDescription" class="form-input text-sm" placeholder="Add or generate a sentence describing this skill."></textarea>
          <div class="flex gap-2">
            <button type="button" data-action="generateSkillSentence" data-skill="${skill}" class="text-xs bg-indigo-100 text-indigo-700 font-semibold py-1 px-2 rounded hover:bg-indigo-200">Generate Example Sentence</button>
            <button type="button" data-action="generateSkillSentence" data-skill="${skill}" class="text-xs bg-white border border-indigo-200 text-indigo-700 font-semibold py-1 px-2 rounded hover:bg-indigo-50">Generate Another</button>
          </div>
        </div>
      </div>
    `;

    // ---------- Utilities ----------
    function updateProgress() {
      const pct = Math.max(0, Math.min(100, (currentSection / 6) * 100));
      progressBar.style.width = pct + '%';
    }

    function goToSection(n) {
      if (n < 0 || n > 6) return;
      const current = form.querySelector(`.form-section[data-section="${currentSection}"]`);
      if (current) current.classList.remove('active');

      let next = form.querySelector(`.form-section[data-section="${n}"]`);
      if (!next) {
        form.insertAdjacentHTML('beforeend', sectionTemplates[n]);
        next = form.querySelector(`.form-section[data-section="${n}"]`);
        // Initialize dynamic containers
        if (n === 1) updateResumeTypeSuggestion(document.getElementById('lastJob').value);
        if (n === 3) {
          if (resumeData.resumeType === 'traditional') {
            addDynamicEntry('workExperiences', workEntryTemplate);
            document.getElementById('workExperienceContainer').classList.remove('hidden');
            document.getElementById('noWorkExperienceContainer').classList.add('hidden');
          } else {
            document.getElementById('workExperienceContainer').classList.add('hidden');
            document.getElementById('noWorkExperienceContainer').classList.remove('hidden');
          }
        }
        if (n === 4) addDynamicEntry('educationEntries', eduEntryTemplate);
      }
      currentSection = n;
      next.classList.add('active');
      updateProgress();
      window.scrollTo(0, 0);
      if (n === 6) generatePreview();
      styleFormElements();
    }

    function addDynamicEntry(containerId, templateFn) {
      const container = document.getElementById(containerId);
      if (!container) return;
      const id = Date.now() + Math.floor(Math.random() * 1000);
      container.insertAdjacentHTML('beforeend', templateFn(id));
      const group = document.getElementById(container.lastElementChild?.id);
      if (containerId === 'workExperiences') populateDateDropdowns(group);
      if (containerId === 'educationEntries') populateGradYearDropdown(group);
    }

    function populateDateDropdowns(container) {
      const currentYear = new Date().getFullYear();
      const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      const startY = container.querySelector('select[name="startYear"]');
      const endY   = container.querySelector('select[name="endYear"]');
      const startM = container.querySelector('select[name="startMonth"]');
      const endM   = container.querySelector('select[name="endMonth"]');

      if (startY) {
        startY.innerHTML = '<option value="">Year</option>';
        for (let y = currentYear; y >= currentYear - 70; y--) startY.innerHTML += `<option>${y}</option>`;
      }
      if (endY) {
        endY.innerHTML = '<option value="">Year</option><option>Present</option>';
        for (let y = currentYear; y >= currentYear - 70; y--) endY.innerHTML += `<option>${y}</option>`;
      }
      if (startM) {
        startM.innerHTML = '<option value="">Month</option>' + months.map(m=>`<option>${m}</option>`).join('');
      }
      if (endM) {
        endM.innerHTML = '<option value="">Month</option>' + months.map(m=>`<option>${m}</option>`).join('');
      }
    }

    function populateGradYearDropdown(container) {
      const currentYear = new Date().getFullYear();
      const gradYearSelect = container.querySelector('select[name="gradYear"]');
      if (gradYearSelect) {
        for (let y = currentYear + 1; y >= currentYear - 70; y--) gradYearSelect.innerHTML += `<option>${y}</option>`;
      }
    }

    function validateSection(n) {
      const section = form.querySelector(`.form-section[data-section="${n}"]`);
      if (!section) return true;
      section.querySelectorAll('[required]:not(:disabled)').forEach(el => {
        el.classList.remove('ring-2','ring-red-500','border-red-500');
        const msg = el.closest('.form-group')?.querySelector('.error-message');
        if (msg) msg.remove();
      });

      let ok = true;
      const required = section.querySelectorAll('[required]:not(:disabled)');
      required.forEach(el => {
        if (!el.value || !String(el.value).trim()) {
          ok = false;
          el.classList.add('ring-2','ring-red-500','border-red-500');
          const p = document.createElement('p');
          p.className = 'error-message text-xs text-red-600 mt-1';
          p.textContent = 'This field is required.';
          (el.closest('.form-group') || el.parentElement).appendChild(p);
        }
      });
      return ok;
    }

    function styleFormElements() {
      form.querySelectorAll('input, textarea, select').forEach(el => {
        if (!el.classList.contains('form-input')) {
          el.classList.add('form-input','w-full','px-3','py-2','border','border-gray-300','rounded-md','shadow-sm','focus:outline-none','focus:ring-2','focus:ring-indigo-500','focus:border-indigo-500','transition-colors');
        }
      });
      form.querySelectorAll('.btn-primary, .btn-secondary, .btn-success').forEach(btn => {
        if (btn.dataset.styled) return;
        btn.dataset.styled = true;
        const base = 'inline-flex items-center justify-center px-6 py-3 border text-base font-semibold rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-transform hover:scale-105';
        if (btn.classList.contains('btn-primary')) btn.className = `btn-primary ${base} border-transparent text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500`;
        if (btn.classList.contains('btn-secondary')) btn.className = `btn-secondary ${base} border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:ring-indigo-500`;
        if (btn.classList.contains('btn-success')) btn.className = `btn-success ${base} w-full sm:w-auto border-transparent text-white bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500`;
      });
    }

    function updateResumeTypeSuggestion(val) {
      const box = document.getElementById('resumeTypeSuggestion');
      let text = '';
      if (val === 'more-than-5-years' || val === 'first-job') {
        resumeData.resumeType = 'skills-based';
        text = `<strong>Recommended: Skills-Based.</strong> Weâ€™ll emphasize your abilities and training.`;
      } else {
        resumeData.resumeType = 'traditional';
        text = `<strong>Recommended: Traditional (Chronological).</strong> Best when your work history is recent.`;
      }
      box.innerHTML = text;
      box.classList.remove('hidden');
    }

    // ---------- Generators (CAR + Skills) ----------
    // CAR generator â€” combinational; seeded by title+company to get "100k+" realistic variations; displays 3 at a time.
    const actionVerbs = ["implemented","optimized","coordinated","streamlined","launched","trained","audited","calibrated","inspected","resolved","led","designed","standardized","consolidated","negotiated","documented","analyzed","improved","reduced","increased"];
    const challenges = [
      "high defect rates","slow order processing","inventory inaccuracies","long wait times","food waste","schedule gaps","safety incidents","low customer satisfaction","missed delivery windows","unreliable vendor lead times","untrained staff","outdated SOPs","manual errors","equipment downtime"
    ];
    const metrics = [
      ["cost","%"],["time","%"],["errors","%"],["throughput","%"],["on-time delivery","%"],["customer satisfaction"," pts"],["scrap","%"],["waste","%"],["uptime","%"],["revenue","%"],["units/hour",""],["NPS"," pts"]
    ];
    const scopes = ["across 3 departments","on a 12-person team","for a 40-seat dining room","across 2 shifts","for 5 sites","for 200+ daily orders","serving 150+ patrons/day","supporting 25 SKUs","across 4 routes"];

    function seededRand(seed) {
      let t = seed + 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
    function pick(arr, r) { return arr[Math.floor(r * arr.length) % arr.length]; }

    function generateCarTriplet(title, company, offset=0) {
      const seedBase = (title + '|' + company + '|' + offset).toLowerCase().split('').reduce((a,c)=>a+c.charCodeAt(0),0);
      const examples = [];
      for (let i=0; i<3; i++) {
        const r1 = seededRand(seedBase + i*3 + 1);
        const r2 = seededRand(seedBase + i*3 + 2);
        const r3 = seededRand(seedBase + i*3 + 3);
        const ch = pick(challenges, r1);
        const act = pick(actionVerbs, r2);
        const [mName, mUnit] = pick(metrics, r3);
        let val = Math.floor(seededRand(seedBase + i*7 + 11) * 35) + 10; // 10..45 typical
        if (mName === "revenue") val = Math.floor(seededRand(seedBase + i*9 + 13) * 25) + 5; // 5..30
        const scope = pick(scopes, seededRand(seedBase + i*5 + 17));
        const bullet = `â€¢ Faced ${ch} at ${company}; ${act} ${title.toLowerCase()} workflows ${scope}, resulting in ${mName} ${mUnit.trim()? (mUnit.startsWith('%')? `${val}%` : `${val}${mUnit}`) : val}.`;
        examples.push(bullet);
      }
      return examples;
    }

    // Skill sentence generator â€” combinational, thousands of variations per skill.
    const skillStarters = ["Applied","Demonstrated","Leveraged","Utilized","Strengthened","Consistently practiced","Implemented"];
    const skillContexts = [
      "in fast-paced environments","while serving diverse customers","across cross-functional teams","under minimal supervision",
      "while adhering to safety and quality standards","during peak-demand periods","within SLA targets","in high-volume operations"
    ];
    const skillActions = [
      "to solve operational problems quickly","to improve task accuracy","to support team goals","to reduce rework and delays",
      "to streamline daily workflows","to maintain compliance with SOPs","to boost service quality","to meet or exceed daily targets"
    ];
    const skillOutcomes = [
      "cutting errors by","increasing throughput by","reducing wait times by","raising satisfaction scores by",
      "improving on-time completion by","reducing escalations by","shortening training time by","improving first-pass yield by"
    ];
    function generateSkillSentence(skill) {
      const s = skill.toLowerCase();
      const r1 = Math.random(), r2 = Math.random(), r3 = Math.random(), r4 = Math.random(), r5 = Math.random();
      const starter = pick(skillStarters, r1);
      const ctx = pick(skillContexts, r2);
      const act = pick(skillActions, r3);
      const out = pick(skillOutcomes, r4);
      const val = Math.floor(10 + r5 * 35); // 10..45
      return `${starter} ${s} ${ctx} ${act}, ${out} ${val}%.`;
    }

    // ---------- Preview / Export / Email ----------
    function collectData() {
      const data = {
        type: resumeData.resumeType,
        name: document.getElementById('fullName')?.value?.trim() || '',
        phone: document.getElementById('phone')?.value?.trim() || '',
        email: document.getElementById('email')?.value?.trim() || '',
        location: document.getElementById('location')?.value?.trim() || '',
        work: [],
        education: [],
        skills: []
      };
      // Work
      document.querySelectorAll('#workExperiences .entry-group').forEach(g=>{
        const get = n => g.querySelector(`[name="${n}"]`)?.value?.trim() || '';
        const title = get('jobTitle'), company = get('company');
        const sm = get('startMonth'), sy = get('startYear'), em = get('endMonth'), ey = get('endYear');
        const bullets = get('responsibilities');
        if (title || company || bullets) {
          data.work.push({ title, company, start:`${sm||''} ${sy||''}`.trim(), end:`${em||''} ${ey||''}`.trim(), bullets });
        }
      });
      // Education
      document.querySelectorAll('#educationEntries .entry-group').forEach(g=>{
        const get = n => g.querySelector(`[name="${n}"]`)?.value?.trim() || '';
        const type = get('degreeType');
        const school = get('school');
        const degree = type === 'Certificate'
          ? (get('certificateName') || get('degree'))
          : get('degree');
        const gradYear = get('gradYear');
        const desc = get('eduDescription');
        if (school || degree) data.education.push({ type, school, degree, gradYear, desc });
      });
      // Skills
      document.querySelectorAll('#skillsList .entry-group').forEach(g=>{
        const skill = g.querySelector('p.font-bold')?.textContent?.trim();
        const sent = g.querySelector('textarea[name="skillDescription"]')?.value?.trim() || '';
        if (skill) data.skills.push({ skill, sent });
      });
      return data;
    }

    function generatePreview() {
      const data = collectData();
      const wrap = document.getElementById('resumePreview');
      const lines = [];

      lines.push(`<h3>${escapeHtml(data.name || 'Your Name')}</h3>`);
      const contact = [data.location, data.phone, data.email].filter(Boolean).join(' | ');
      lines.push(`<div class="contact-info">${escapeHtml(contact)}</div>`);

      if (data.type === 'skills-based' && data.skills.length) {
        lines.push(`<h4>Skills</h4>`);
        lines.push(`<ul class="skills-list">${data.skills.map(s=>`<li><strong>${escapeHtml(s.skill)}:</strong> ${escapeHtml(s.sent)}</li>`).join('')}</ul>`);
      }

      if (data.work.length && data.type === 'traditional') {
        lines.push(`<h4>Experience</h4>`);
        data.work.forEach(w=>{
          const header = `
            <div class="entry">
              <div class="entry-header">
                <div class="title">${escapeHtml(w.title)} â€” ${escapeHtml(w.company)}</div>
                <div class="meta">${escapeHtml((w.start||'').trim() || '')}${(w.end||'') ? ' â€” ' + escapeHtml((w.end||'').trim()) : ''}</div>
              </div>
              ${w.bullets ? `<ul>${escapeHtml(w.bullets).split(/\n|â€¢/).filter(Boolean).map(b=>`<li>${escapeHtml(b.trim().replace(/^\-|\*/,'').replace(/^â€¢/,'').trim())}</li>`).join('')}</ul>`:''}
            </div>
          `;
          lines.push(header);
        });
      }

      if (data.education.length) {
        lines.push(`<h4>Education</h4>`);
        data.education.forEach(e=>{
          const top = `<div class="entry"><div class="entry-header"><div class="title">${escapeHtml(e.degree)} â€” ${escapeHtml(e.school)}</div><div class="meta">${escapeHtml(e.gradYear||'')}</div></div>`;
          const desc = e.desc ? `<div class="mt-1 text-sm">${escapeHtml(e.desc)}</div>` : '';
          lines.push(`${top}${desc}</div>`);
        });
      }

      if (data.type === 'skills-based' && data.work.length) {
        lines.push(`<h4>Experience</h4>`);
        data.work.forEach(w=>{
          const header = `
            <div class="entry">
              <div class="entry-header">
                <div class="title">${escapeHtml(w.title)} â€” ${escapeHtml(w.company)}</div>
                <div class="meta">${escapeHtml((w.start||'').trim() || '')}${(w.end||'') ? ' â€” ' + escapeHtml((w.end||'').trim()) : ''}</div>
              </div>
              ${w.bullets ? `<ul>${escapeHtml(w.bullets).split(/\n|â€¢/).filter(Boolean).map(b=>`<li>${escapeHtml(b.trim().replace(/^\-|\*/,'').replace(/^â€¢/,'').trim())}</li>`).join('')}</ul>`:''}
            </div>
          `;
          lines.push(header);
        });
      }

      if (data.type === 'traditional' && data.skills.length) {
        lines.push(`<h4>Skills</h4>`);
        lines.push(`<ul class="skills-list">${data.skills.map(s=>`<li><strong>${escapeHtml(s.skill)}:</strong> ${escapeHtml(s.sent)}</li>`).join('')}</ul>`);
      }

      wrap.innerHTML = lines.join('');
    }

    function escapeHtml(s=''){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

    async function downloadDocx() {
      const data = collectData();
      const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;

      const docChildren = [];

      // Name
      docChildren.push(new Paragraph({
        alignment: AlignmentType.CENTER,
        children: [new TextRun({ text: data.name || 'Your Name', bold: true, size: 48 })],
      }));

      // Contact
      const contact = [data.location, data.phone, data.email].filter(Boolean).join(' | ');
      if (contact) {
        docChildren.push(new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text: contact, size: 20, italics: true })] }));
      }

      const addHeading = (t) => docChildren.push(new Paragraph({ text: t.toUpperCase(), heading: HeadingLevel.HEADING_3 }));

      // Skills-first (skills-based)
      if (resumeData.resumeType === 'skills-based' && data.skills.length) {
        addHeading('Skills');
        data.skills.forEach(s=>{
          docChildren.push(new Paragraph({ children: [new TextRun({ text: `${s.skill}: ${s.sent}`, size: 22 })] }));
        });
      }

      // Experience
      if (data.work.length) {
        addHeading('Experience');
        data.work.forEach(w=>{
          const line1 = `${w.title || ''}${w.title && w.company ? ' â€” ' : ''}${w.company || ''}`;
          const line2 = `${(w.start||'').trim()}${w.end ? ' â€” ' + (w.end||'').trim() : ''}`;
          if (line1.trim()) docChildren.push(new Paragraph({ children: [new TextRun({ text: line1, bold: true, size: 24 })] }));
          if (line2.trim()) docChildren.push(new Paragraph({ children: [new TextRun({ text: line2, italics: true, size: 20 })] }));
          (w.bullets || '').split(/\n|â€¢/).filter(Boolean).forEach(b=>{
            docChildren.push(new Paragraph({ children: [new TextRun({ text: 'â€¢ ' + b.trim(), size: 22 })] }));
          });
        });
      }

      // Education
      if (data.education.length) {
        addHeading('Education');
        data.education.forEach(e=>{
          const line1 = `${e.degree || ''}${(e.degree && e.school)?' â€” ':''}${e.school || ''}`;
          const line2 = `${e.gradYear || ''}`;
          if (line1.trim()) docChildren.push(new Paragraph({ children: [new TextRun({ text: line1, bold: true, size: 24 })] }));
          if (line2.trim()) docChildren.push(new Paragraph({ children: [new TextRun({ text: line2, italics: true, size: 20 })] }));
          if (e.desc) docChildren.push(new Paragraph({ children: [new TextRun({ text: e.desc, size: 22 })] }));
        });
      }

      // Skills-last (traditional)
      if (resumeData.resumeType === 'traditional' && data.skills.length) {
        addHeading('Skills');
        data.skills.forEach(s=>{
          docChildren.push(new Paragraph({ children: [new TextRun({ text: `${s.skill}: ${s.sent}`, size: 22 })] }));
        });
      }

      const doc = new Document({ sections: [{ children: docChildren }] });
      const blob = await Packer.toBlob(doc);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (data.name ? data.name.replace(/\s+/g,'_') : 'resume') + '.docx';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function composeEmailBody() {
      const data = collectData();
      const lines = [];
      lines.push((data.name || 'Your Name'));
      const contact = [data.location, data.phone, data.email].filter(Boolean).join(' | ');
      if (contact) lines.push(contact);
      lines.push('');

      function pushBullets(s) {
        (s || '').split(/\n|â€¢/).filter(Boolean).forEach(b=>lines.push('â€¢ ' + b.trim()));
      }

      if (resumeData.resumeType === 'skills-based' && data.skills.length) {
        lines.push('SKILLS:');
        data.skills.forEach(s=>lines.push(`- ${s.skill}: ${s.sent}`));
        lines.push('');
      }

      if (data.work.length) {
        lines.push('EXPERIENCE:');
        data.work.forEach(w=>{
          lines.push(`${w.title || ''}${(w.title && w.company)?' â€” ':''}${w.company || ''}`);
          const dates = `${(w.start||'').trim()}${w.end? ' â€” ' + (w.end||'').trim() : ''}`;
          if (dates.trim()) lines.push(dates);
          pushBullets(w.bullets);
          lines.push('');
        });
      }

      if (data.education.length) {
        lines.push('EDUCATION:');
        data.education.forEach(e=>{
          lines.push(`${e.degree || ''}${(e.degree && e.school)?' â€” ':''}${e.school || ''}`);
          if (e.gradYear) lines.push(e.gradYear);
          if (e.desc) lines.push(e.desc);
          lines.push('');
        });
      }

      if (resumeData.resumeType === 'traditional' && data.skills.length) {
        lines.push('SKILLS:');
        data.skills.forEach(s=>lines.push(`- ${s.skill}: ${s.sent}`));
        lines.push('');
      }

      return lines.join('%0D%0A'); // URL-encoded line breaks
    }

    function isResumeEmpty() {
      const d = collectData();
      const contactOk = d.name && d.email;
      const hasAny = (d.work && d.work.length) || (d.education && d.education.length) || (d.skills && d.skills.length);
      return !(contactOk && hasAny);
    }

    function openWarning(onContinue) {
      modal.style.display = 'flex';
      const cont = document.getElementById('modalContinueBtn');
      const cancel = document.getElementById('modalCancelBtn');
      const closeAll = ()=> modal.style.display = 'none';
      cont.onclick = ()=>{ closeAll(); onContinue && onContinue(); };
      cancel.onclick = closeAll;
    }

    // ---------- Event handlers ----------
    form.addEventListener('click', (e)=>{
      const action = e.target.dataset.action;
      if (!action) return;

      const actions = {
        start: ()=> goToSection(1),
        next: ()=> { if (validateSection(currentSection)) goToSection(currentSection + 1); },
        prev: ()=> goToSection(currentSection - 1),
        addWork: ()=> addDynamicEntry('workExperiences', workEntryTemplate),
        addEdu: ()=> addDynamicEntry('educationEntries', eduEntryTemplate),
        remove: ()=> document.getElementById(e.target.dataset.target)?.remove(),
        generateCar: ()=> handleCar(e, /*offset*/0),
        moreCar: ()=> handleCar(e, /*offset*/ Math.floor(Math.random()*100000)),
        addSkill: ()=>{
          const input = document.getElementById('newSkill');
          const skill = input.value.trim();
          if (skill) {
            const id = Date.now();
            document.getElementById('skillsList').insertAdjacentHTML('beforeend', skillEntryTemplate(skill, id));
            input.value = '';
          }
        },
        generateSkillSentence: ()=>{
          const skill = e.target.dataset.skill;
          const area = e.target.closest('.entry-group')?.querySelector('textarea[name="skillDescription"]');
          if (area) area.value = generateSkillSentence(skill);
        },
        download: ()=>{
          const proceed = ()=> downloadDocx();
          if (isResumeEmpty()) openWarning(proceed); else proceed();
        },
        email: ()=>{
          const proceed = ()=>{
            const subject = encodeURIComponent('Resume Submission');
            const body = composeEmailBody();
            window.location.href = `mailto:EandE@trentonsoupkitchen.org?subject=${subject}&body=${body}`;
          };
          if (isResumeEmpty()) openWarning(proceed); else proceed();
        }
      };
      if (actions[action]) actions[action]();
    });

    form.addEventListener('change', (e)=>{
      const act = e.target.dataset.action;
      if (e.target.id === 'lastJob') updateResumeTypeSuggestion(e.target.value);
      if (act === 'degreeTypeChange') {
        const group = e.target.closest('.entry-group');
        const deg = group.querySelector('[name="degree"]');
        const cert = group.querySelector('[name="certificateName"]');
        if (e.target.value === 'Certificate') {
          cert.classList.remove('hidden');
          deg.placeholder = 'e.g., General Certificate';
        } else {
          cert.classList.add('hidden');
          deg.placeholder = 'e.g., B.S. in Marketing';
        }
      }
    });

    form.addEventListener('input', (e)=>{
      if (e.target.id === 'phone') {
        let x = e.target.value.replace(/\D/g,'').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
        e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
      }
    });

    function handleCar(targetEvent, offset) {
      const grp = targetEvent.target.closest('.entry-group');
      if (!grp) return;
      const title = grp.querySelector('[name="jobTitle"]')?.value?.trim() || 'Team Member';
      const company = grp.querySelector('[name="company"]')?.value?.trim() || 'Company';
      const sugg = grp.querySelector('.car-suggestions');
      const bullets = generateCarTriplet(title, company, offset)
        .map(b=>`<button type="button" class="block text-left w-full bg-white border rounded-md px-3 py-2 hover:bg-indigo-50 select-bullet">${escapeHtml(b)}</button>`)
        .join('');
      sugg.innerHTML = `<div class="space-y-2">${bullets}</div>`;
      sugg.classList.remove('hidden');

      sugg.querySelectorAll('.select-bullet').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const area = grp.querySelector('textarea[name="responsibilities"]');
          const val = btn.textContent;
          area.value = (area.value ? area.value + '\n' : '') + val;
        });
      });
    }

    // ---------- Init ----------
    form.innerHTML = sectionTemplates[0];
    styleFormElements();
    goToSection(0);

    // Keep inputs/buttons styled on DOM changes
    const observer = new MutationObserver(styleFormElements);
    observer.observe(form, { childList: true, subtree: true });

  </script>
</body>
</html>
